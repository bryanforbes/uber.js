<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Tests</title>

    <style>
        .error {
            color: red;
        }
    </style>

    <script src="../has.js/has.js"></script>
    <script src="../has.js/detect/array.js"></script>
    <script src="../has.js/detect/strings.js"></script>
    <script src="../has.js/detect/bugs.js"></script>
    <script src="../has.js/detect/dom.js"></script>
    <script src="../has.js/detect/css.js"></script>
    <script src="../has.js/detect/function.js"></script>
    <script src="../has.js/detect/object.js"></script>
    <script src="../has.js/detect/events.js"></script>
    <script src="../has.js/detect/features.js"></script>
    <script src="../uber.js"></script>
    <script src="../src/array.js"></script>
    <script src="../src/function.js"></script>
    <script src="../src/object.js"></script>
    <script src="../src/string.js"></script>
    <script src="../src/promise.js"></script>
    <script src="../src/deferred.js"></script>
    <script src="../src/deferreds.js"></script>
    <script src="../src/dom.js"></script>
    <script src="../src/dom-event.js"></script>
    <script src="../src/html.js"></script>
    <script src="../src/dispatcher.js"></script>
    <script src="../src/pubsub.js"></script>
    <script src="../src/xhr.js"></script>

    <script src="test.js"></script>

    <script>
        registerTest("indexOf", function(){
            return uber.indexOf([1,2,2,3], 2) == 1;
        });
        registerTest("lastIndexOf", function(){
            return uber.lastIndexOf([1,2,2,3], 2) == 2;
        });
        registerTest("every", function(){
            return uber.every([1,1,1,1], function(a){ return a == 1; }) &&
                !uber.every([1,2,1,1], function(a){ return a == 1; });
        });
        registerTest("some", function(){
            return uber.some([1,2,3,4], function(a){ return a == 4; }) &&
                !uber.some([1,2,3,4], function(a){ return a == 5; });
        });
        registerTest("forEach", function(){
            var arr = [1,2,3];
            arr[4] = 5;
            var count = 0;
            uber.forEach(arr, function(){
                count++;
            });
            return count == 4;
        });
        registerTest("map", function(){
            return isEqual(uber.map([1,2,3,4], function(a){ return a + 1; }), [2,3,4,5]);
        });
        registerTest("filter", function(){
            return isEqual(uber.filter([1,2,3,4], function(a){ return a < 4; }), [1,2,3]);
        });
        registerTest("reduce", function(){
            return isEqual(uber.reduce([1,2,3,4], function(a, b){ return a + b; }), 10);
        });
        registerTest("reduceRight", function(){
            return isEqual(uber.reduceRight([1,2,3,4], function(a, b){ return a + b; }), 10);
        });
        (function(){
            var obj1 = {
                prop: "foo"
            };
            var obj2 = {
                prop: "bar",
                method: function(arg){
                    return arg ? (arg + " " + (this.prop||"none")) : this.prop;
                },
                toString: function(){
                    return "obj2";
                }
            };
            registerTest("bind", function(){
                var b1 = uber.bind(obj2.method, obj1);
                var b2 = uber.bind(obj2.method, obj2, "foo");
                return b1() == "foo" && b2() == "foo bar";
            });
            registerTest("curry", function(){
                var c1 = uber.curry(obj2.method, "foo");
                return c1() == "foo none" && c1.call(obj1) == "foo foo";
            });

            registerTest("forIn", function(){
                // forIn should not skip toString (IE) and shouldn't double each key (Saf2)
                var count = 0;
                uber.forIn(obj2, function(){ count++; });

                return count == 3;
            });

            registerTest("keys", function(){
                return uber.keys(obj2).length == 3;
            });

            var obj3 = uber.create(obj2, {
                prop1: "baz"
            });
            registerTest("hasKey", function(){
                return uber.hasKey(obj3, "prop1") && !uber.hasKey(obj3, "method");
            });

            registerTest("create", function(){
                var result = obj3.prop1 == "baz" && ("prop" in obj3) && obj3.prop == "bar";
                obj2.prop = "blah";
                return result && obj3.prop == "blah";
            });
        })();

        registerTest("isArray", function(){
            return uber.isArray([]);
        });
        registerTest("isFunction", function(){
            return uber.isFunction(function(){});
        });
        registerTest("isString", function(){
            return uber.isString("");
        });
        registerTest("isNumber", function(){
            return uber.isNumber(1000) && !uber.isNumber(Infinity);
        });
        registerTest("isRegExp", function(){
            return uber.isRegExp(/^$/);
        });

        registerTest("trim", function(){
            return uber.trim("\u0009\u000A\u000B\u000C\u000D\u0020\u00A0\u1680\u180E\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007asdf\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029") == 'asdf' &&
                uber.trim("\u0009\u000A\u000B\u000C\u000D\u0020\u00A0\u1680\u180E\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007asdf\uFEFFasdf\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF") == 'asdf\uFEFFasdf';
        });

        (function(){
            registerTest("promise/deferred", function(){
                var d = new uber.Deferred;
                var a1, a2, a3, a4;
                d.then(function(arg){ a1 = arg; return 2; }).then(function(arg){ a2 = arg; return 3; });
                d.then(function(arg){ a3 = arg; return 4; });
                uber.when(d, function(arg){ a4 = arg; });
                d.resolve(1);

                return a1 == 1 && a2 == 2 && a3 == 1 && a4 == 1;
            });
        })();

        (function(){
            var originalCalled, bCalled, cCalled;
            originalCalled = bCalled = cCalled = false;
            var a = { foo: function(){ originalCalled = true; return 1; } };
            var b = uber.connect(a, "foo", function(){ bCalled = true; return 2; });
            var c = uber.connect(a, "foo", function(){ cCalled = true; return 3; });

            registerTests("connect", [
                function(){
                    var res = a.foo();
                    return res == 1 && originalCalled && bCalled && cCalled;
                },
                function(){
                    originalCalled = bCalled = cCalled = false;
                    b.pause();
                    a.foo();
                    return originalCalled && !bCalled && cCalled;
                },
                function(){
                    originalCalled = bCalled = cCalled = false;
                    b.resume();
                    a.foo();
                    return originalCalled && bCalled && cCalled;
                },
                function(){
                    originalCalled = bCalled = cCalled = false;
                    b.cancel();
                    a.foo();
                    return originalCalled && !bCalled && cCalled;
                },
                function(){
                    originalCalled = bCalled = cCalled = false;
                    c.cancel();
                    a.foo();
                    return originalCalled && !bCalled && !cCalled;
                }
            ]);
        })();
        (function(){
            var aCalled, bCalled, cCalled, dCalled;
            var a = uber.subscribe("some:foo", function(args){ aCalled = true; });
            var b = uber.subscribe("some:foo", function(args){ bCalled = true; });
            var c = uber.subscribe("some:foo", function(args){ cCalled = true; });
            var d = uber.subscribe("some:other:foo", function(args){ dCalled = true; });

            registerTests("pubsub", [
                function(){
                    aCalled = bCalled = cCalled = dCalled = false;
                    uber.publish("some:foo");
                    return aCalled && bCalled && cCalled && !dCalled;
                },
                function(){
                    aCalled = bCalled = cCalled = dCalled = false;
                    b.pause();
                    uber.publish("some:foo");
                    return aCalled && !bCalled && cCalled && !dCalled;
                },
                function(){
                    aCalled = bCalled = cCalled = dCalled = false;
                    uber.publish("some:other:foo");
                    return !aCalled && !bCalled && !cCalled && dCalled;
                },
                function(){
                    aCalled = bCalled = cCalled = dCalled = false;
                    b.resume();
                    uber.publish("some:foo");
                    return aCalled && bCalled && cCalled && !dCalled;
                },
                function(){
                    aCalled = bCalled = cCalled = dCalled = false;
                    a.cancel();
                    b.cancel();
                    c.cancel();
                    uber.publish("some:foo");
                    return !aCalled && !bCalled && !cCalled && !dCalled;
                }
            ]);
        })();
        /*function runTests(){
            (function(){
                var x1 = uber.xhr("GET", { url: "test.js" }),
                    x2 = uber.xhr("GET", { url: "test.jss" }),
                    x3 = uber.xhr("GET", { url: "test.js" });
                x3.cancel();

                var defs = new uber.Deferreds([x1,x2,x3]);

                defs.then(
                    function(res){
                        outputResult("xhr", res[0][0] && res[0][1].status == 200 && res[0][1].responseText.slice(0, 10) == "(function(");
                        outputResult("xhr, again", !res[1][0]);
                        outputResult("xhr, once more", !res[2][0]);
                    }
                );
            })();
        }*/
    </script>
</head>
<body>
    <ul id="output"></ul>
</body>
</html>
